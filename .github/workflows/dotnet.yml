# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
    push:
        branches: ['main']
    pull_request:
        branches: ['main']

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 8.0.x
            - name: Restore dependencies
              run: dotnet restore
            - name: Build
              run: dotnet build --no-restore
            - name: Test
              run: dotnet test --no-build --verbosity normal
            - name: Publish Release - Self-contained
              if: success() # chỉ chạy khi các bước trước thành công
              run: dotnet publish ProductManager.API/ProductManager.API.csproj -c Release --self-contained true -r win-x64 -o ./publish

            # Dùng upload-artifact và download-artifact để chia sẻ thư mục publish giữa các jobs.
            - name: Upload published app
              uses: actions/upload-artifact@v4
              with:
                  name: published-app
                  path: ./publish
                  retention-days: 1 # Hoặc 1-90 ngày tùy ý

    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        needs: build

        steps:
            #  tải artifact xuống và đưa vào release
            - name: Download published app
              uses: actions/download-artifact@v4
              with:
                  name: published-app
                  path: ./publish

            # tao zip # Nén toàn bộ thư mục publish
            - name: Zip folder
              run: |
                  zip -r my_folder.zip ./publish

            # tao  tar # Nén toàn bộ thư mục publish
            - name: Tar folder
              run: |
                  tar -czvf my_folder.tar.gz ./publish

            # upload cac build len artifact
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: my-zipped-folder
                  path: my_folder.zip my_folder.tar.gz

            # tao github release
            - name: Create GitHub Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token tự động có sẵn
              with:
                  # tag_name: ${{ github.ref_name }}  # Lấy tên tag (ví dụ: v1.0.0)
                  # release_name: "Release ${{ github.ref_name }}"
                  tag_name: 'v1.0.0' # ✅ Đặt tên tag rõ ràng
                  release_name: 'Release v1.0.0'
                  draft: false
                  prerelease: false

            - name: Upload ZIP to Release
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }} # URL từ bước tạo release
                  asset_path: ./my_folder.zip
                  asset_name: my_folder.zip
                  asset_content_type: application/zip

            - name: Upload TAR.GZ to Release
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./my_folder.tar.gz
                  asset_name: my_folder.tar.gz
                  asset_content_type: application/gzip
